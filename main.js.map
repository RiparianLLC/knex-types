{"version":3,"file":"main.js","names":["updateTypes","db","options","overrides","output","fs","createWriteStream","encoding","forEach","line","write","schema","split","map","x","trim","includeSchemas","excludeSchemas","reduce","acc","s","startsWith","push","exclude","prefix","enums","table","join","orderBy","select","i","key","enumName","value","replace","enumsMap","Map","columns","withSchema","whereIn","whereNotIn","raw","tablesEnumName","tables","Set","JSON","stringify","t","parse","find","tableName","overrideName","schemaName","tablesTypeName","isTableFirstColumn","columnName","column","isArrayType","type","overrideType","getType","nullable","typePostProcessor","sanitize","suffix","end","destroy","customTypes","udt","substring","default","get","name","test","typeOverrides","overrideTableColumnTypes","tableColumnType","isFunction","overrideColumnTypes","columnType","overrideDefaultTypes","category","defaultValue","override"],"sources":["main.ts"],"sourcesContent":["/* SPDX-FileCopyrightText: 2016-present Kriasoft <hello@kriasoft.com> */\n/* SPDX-License-Identifier: MIT */\n\nimport fs from 'fs';\nimport { Knex } from 'knex';\nimport { camelCase, upperFirst } from 'lodash';\nimport type { Writable } from 'stream';\n\nexport type Options = {\n  /**\n   * Filename or output stream where the type definitions needs to be written.\n   */\n  output: Writable | string;\n\n  /**\n   * The name of the exported enum (Which encapsulates all tables)\n   * Default: \"Table\"\n   */\n  tablesEnumName?: string;\n\n  /**\n   * The name of the exported tables type\n   * Default: \"Tables\"\n   */\n  tablesTypeName?: string;\n\n  /**\n   * Name overrides for enums, schemas, tables and columns.\n   * Check tests for more info.\n   *\n   * @example\n   *   overrides: {\n   *     \"identity_provider.linkedin\": \"LinkedIn\"\n   *   }\n   *\n   * @example\n   * Override a table name with a function\n   *\n   *   overrides: {\n   *     // Overwrite the 'user' table name\n   *     user: (x, type, defaultValue) => UserTable\n   *   }\n   *\n   * @example\n   * Tag all schemas, tables and columns\n   *\n   *  overrides: {\n   *     // Append \"Table\" to all tables and TitleCase the name\n   *     \"*\": (x, type, defaultValue) => type === \"table\" ? \"Table\" +  upperFirst(camelCase(x.table)) : defaultValue\n   *   }\n   */\n  overrides?: Record<string, OverrideStringFunction>;\n\n  /**\n   * Overrides of column types.\n   * Overrides have higher priority the more specific they are, from highest to lowest:\n   *\n   * 1. A single table's column\n   * 2. All tables columns\n   * 3. Database's default types\n   *\n   * If any of these types can overwrite the other, the one with the higher specificity will be chosen.\n   *\n   * The special `\"*\"` can be used to match all columns after all types have been set. If it's a function\n   * call it, otherwise just return the value.\n   * Whatever this special override returns will overwrite all other processed types. That's why it's\n   * recommended for this property to be a function, as the second argument provided will be the already\n   * processed type.\n   *\n   * @example\n   * Override a specific table's column.\n   * If `overrideTableColumnTypes` is set to true, a table's column type will be overwritten\n   * with the provided custom type.\n   * Check tests for more info.\n   *\n   *   typeOverrides: {\n   *     // Will only modify the `notes` column in the `messages` table.\n   *     \"messages.notes\": \"OnlyForThisColumnInThisTable\",\n   *\n   *     // A function can also be provided.\n   *     \"messages.notes\": (x: Column) => \"OnlyForThisColumnInThisTable\"\n   *   }\n   *\n   * @example\n   * Override all columns with the same name.\n   * if `overrideColumnTypes` is set to true, all columns types from all tables that matches\n   * the column name will be overwritten with the provided custom type.\n   * Check tests for more info.\n   *\n   *   typeOverrides: {\n   *     // Will modify all columns called `notes` in all tables.\n   *     \"notes\": \"SomeTypeForAllNotesColumns\",\n   *\n   *     // A function can also be provided.\n   *     \"messages.notes\": (x: Column) => \"SomeTypeForAllNotesColumns\"\n   *   }\n   *\n   * @example\n   * Override a database's default type.\n   * if `overrideDefaultTypes` is set to true, all database's default types that match\n   * the type name will be overwritten with the provided custom type.\n   * Check tests for more info.\n   *\n   *   prefix: 'type Numeric = `${number}` | Number;',\n   *   typeOverrides: {\n   *     // Will modify all decimal columns (which by default are of type 'numeric').\n   *     \"numeric\": \"Numeric\",\n   *\n   *     // A function can also be provided.\n   *     \"numeric\": (x: Column) => \"Numeric\"\n   *   }\n   *\n   * @example\n   * Use the special \"*\" override to format all types (The second argument provided is\n   * the type that has been processed so far).\n   * This value provided will overwrite all types.\n   * Check tests for more info.\n   *\n   *   typeOverrides: {\n   *     // All types will be set to `null`\n   *     \"*\": \"null\",\n   *\n   *     // Append 'Nullable' to all types\n   *     \"numeric\": (x: Column, defaultType: string) => defaultType + ' | Nullable'\n   *   }\n   */\n  typeOverrides?: TypePostProcessor | TypeOverride;\n\n  /**\n   * Enable the overriding of a specific table's column type.\n   * Default value is true.\n   * More info at the `typeOverrides` documentation.\n   */\n  overrideTableColumnTypes?: boolean;\n\n  /**\n   * Enable the overriding of all columns with the same name types.\n   * Default value is true.\n   * More info at the `typeOverrides` documentation.\n   */\n  overrideColumnTypes?: boolean;\n\n  /**\n   * Enable the overriding of the database's default types.\n   * Default value is true.\n   * More info at the `typeOverrides` documentation.\n   */\n  overrideDefaultTypes?: boolean;\n\n  prefix?: string;\n  suffix?: string;\n\n  /**\n   * Schemas that should be included/excluded when generating types.\n   *\n   * By default if this is null/not specified, \"public\" will be the only schema added, but if this property\n   * is specified, public will be excluded by default and has to be included in the list to be added to the output.\n   * If a schema is added by its name, i.e. 'log' all tables from that schema will be added.\n   * If a schema name is added with an exclamation mark it will be ignored, i.e. \"!log\".\n   *\n   * The table-type will be prefixed by its schema name, the table log.message will become LogMessage.\n   *\n   * @example\n   *   // This will include \"public\" and \"log\", but exclude the \"auth\" schema.\n   *   schema: [\"public\", \"log\", \"!auth\"]\n   * @default\n   *   \"public\"\n   */\n  schema?: string[] | string;\n\n  /**\n   * A comma separated list or an array of tables that should be excluded when\n   * generating types.\n   *\n   * @example\n   *   exclude: [\"migration\", \"migration_lock\"]\n   */\n  exclude?: string[] | string;\n};\n\n/**\n * Generates TypeScript definitions (types) from a PostgreSQL database schema.\n */\nexport async function updateTypes(db: Knex, options: Options): Promise<void> {\n  const overrides = options.overrides ?? {};\n  const output: Writable =\n    typeof options.output === 'string'\n      ? fs.createWriteStream(options.output, { encoding: 'utf-8' })\n      : options.output;\n\n  [\n    '// The TypeScript definitions below are automatically generated.\\n',\n    '// Do not touch them, or risk, your modifications being lost.\\n\\n',\n  ].forEach((line) => output.write(line));\n\n  const schema = (typeof options.schema === 'string'\n    ? options.schema.split(',').map((x) => x.trim())\n    : options.schema) ?? ['public'];\n\n  // Schemas to include or exclude\n  const [includeSchemas, excludeSchemas] = schema.reduce(\n    (acc, s) =>\n      (acc[+s.startsWith('!')].push(s) && acc) as [string[], string[]],\n    [[] as string[], [] as string[]]\n  );\n\n  // Tables to exclude\n  const exclude =\n    (typeof options.exclude === 'string'\n      ? options.exclude.split(',').map((x) => x.trim())\n      : options.exclude) ?? [];\n\n  if (options.prefix) {\n    output.write(options.prefix);\n    output.write('\\n\\n');\n  }\n\n  try {\n    // Fetch the list of custom enum types\n    const enums = await db\n      .table('pg_type')\n      .join('pg_enum', 'pg_enum.enumtypid', 'pg_type.oid')\n      .orderBy('pg_type.typname')\n      .orderBy('pg_enum.enumsortorder')\n      .select<Enum[]>('pg_type.typname as key', 'pg_enum.enumlabel as value');\n\n    // Construct TypeScript enum types\n    enums.forEach((x, i) => {\n      // The first line of enum declaration\n      if (!(enums[i - 1] && enums[i - 1].key === x.key)) {\n        const enumName = overrides[x.key] ?? upperFirst(camelCase(x.key));\n        output.write(`export enum ${enumName} {\\n`);\n      }\n\n      // Enum body\n      const key =\n        overrides[`${x.key}.${x.value}`] ??\n        upperFirst(camelCase(x.value.replace(/[.-]/g, '_')));\n      output.write(`  ${key} = \"${x.value}\",\\n`);\n\n      // The closing line\n      if (!(enums[i + 1] && enums[i + 1].key === x.key)) {\n        output.write('};\\n\\n');\n      }\n    });\n\n    const enumsMap = new Map(\n      enums.map((x) => [\n        x.key,\n        (overrides[x.key] as string) ?? upperFirst(camelCase(x.key)),\n      ])\n    );\n\n    // Fetch the list of tables/columns\n    const columns = await db\n      .withSchema('information_schema')\n      .table('columns')\n      .whereIn('table_schema', includeSchemas)\n      .whereNotIn('table_schema', excludeSchemas)\n      .whereNotIn('table_name', exclude)\n      .orderBy('table_schema')\n      .orderBy('table_name')\n      .orderBy('ordinal_position')\n      .select<Column[]>(\n        'table_schema as schema',\n        'table_name as table',\n        'column_name as column',\n        db.raw(\"(is_nullable = 'YES') as nullable\"),\n        'column_default as default',\n        'data_type as type',\n        'udt_name as udt'\n      );\n\n    // The list of database tables as enum\n    output.write(`export enum ${options.tablesEnumName || 'Table'} {\\n`);\n\n    // Unique schema / table combination array\n    const tables: { table: string; schema: string }[] = [\n      ...new Set(\n        columns.map((x) => JSON.stringify({ table: x.table, schema: x.schema }))\n      ),\n    ].map((t) => JSON.parse(t));\n\n    // Write enum tables\n    for (const table of tables) {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const x = columns.find(\n        (x) => x.table === table.table && x.schema === table.schema\n      )!;\n\n      const tableName =\n        overrideName(x, 'table', overrides) ?? upperFirst(camelCase(x.table));\n      let schemaName =\n        x.schema !== 'public' ? upperFirst(camelCase(x.schema)) : '';\n      schemaName = overrideName(x, 'schema', overrides) ?? schemaName;\n      const key = `${schemaName}${tableName}`;\n\n      const schema = x.schema !== 'public' ? `${x.schema}.` : '';\n      const value = `${schema}${x.table}`;\n      output.write(`  ${key} = \"${value}\",\\n`);\n    }\n    output.write('};\\n\\n');\n\n    // Write the list of tables as a type\n    output.write(`export type ${options.tablesTypeName || 'Tables'} = {\\n`);\n    for (const table of tables) {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const x = columns.find(\n        (x) => x.table === table.table && x.schema === table.schema\n      )!;\n\n      const tableName =\n        overrideName(x, 'table', overrides) ?? upperFirst(camelCase(x.table));\n      let schemaName =\n        x.schema !== 'public' ? upperFirst(camelCase(x.schema)) : '';\n      schemaName = overrideName(x, 'schema', overrides) ?? schemaName;\n      const key = `${schemaName}${tableName}`;\n\n      const schema = x.schema !== 'public' ? `${x.schema}.` : '';\n      const value = `${schema}${x.table}`;\n      output.write(`  \"${value}\": ${key},\\n`);\n    }\n    output.write('};\\n\\n');\n\n    // Construct TypeScript db record types\n    columns.forEach((x, i) => {\n      const isTableFirstColumn = !(\n        columns[i - 1] && columns[i - 1].table === x.table\n      );\n\n      // Export schema & table type\n      if (isTableFirstColumn) {\n        const tableName =\n          overrideName(x, 'table', overrides) ?? upperFirst(camelCase(x.table));\n\n        // Doing it this way because I need to separate the trinary expression from the ?? operator (doesn't work).\n        let schemaName =\n          x.schema !== 'public' ? upperFirst(camelCase(x.schema)) : '';\n        schemaName = overrideName(x, 'schema', overrides) ?? schemaName;\n\n        output.write(`export type ${schemaName}${tableName} = {\\n`);\n      }\n\n      // Set column type\n      const columnName = overrideName(x, 'column', overrides) ?? x.column;\n      const isArrayType = x.type === 'ARRAY';\n      let type = overrideType(x, options) ?? getType(x, enumsMap);\n\n      if (isArrayType) type += '[]';\n      if (x.nullable) type += ' | null';\n\n      // Process the \"*\" type override if provided\n      type = typePostProcessor(x, type, options);\n\n      output.write(`  ${sanitize(columnName)}: ${type};\\n`);\n\n      if (!(columns[i + 1] && columns[i + 1].table === x.table)) {\n        output.write('};\\n\\n');\n      }\n    });\n\n    if (options.suffix) {\n      output.write(options.suffix);\n      output.write('\\n');\n    }\n  } finally {\n    output.end();\n    db.destroy();\n  }\n}\n\nexport type Enum = {\n  key: string;\n  value: string;\n};\n\nexport type Column = {\n  table: string;\n  column: string;\n  schema: string;\n  nullable: boolean;\n  default: string | null;\n  type: string;\n  udt: string;\n};\n\nexport type NameOverrideCategory = keyof Column &\n  ('table' | 'schema' | 'column');\nexport type OverrideStringFunction =\n  | string\n  | ((\n      x: Column,\n      category: NameOverrideCategory,\n      defaultValue: string | null\n    ) => string | null);\n\nexport type TypeOverride = Record<string, string | ((x: Column) => string)>;\nexport type TypePostProcessor = Record<\n  '*',\n  string | ((x: Column, defaultType: string) => string)\n>;\n\nexport function getType(x: Column, customTypes: Map<string, string>): string {\n  const udt: string = x.type === 'ARRAY' ? x.udt.substring(1) : x.udt;\n\n  switch (udt) {\n    case 'bool':\n      return 'boolean';\n    case 'text':\n    case 'citext':\n    case 'money':\n    case 'numeric':\n    case 'int8':\n    case 'char':\n    case 'character':\n    case 'bpchar':\n    case 'varchar':\n    case 'time':\n    case 'tsquery':\n    case 'tsvector':\n    case 'uuid':\n    case 'xml':\n    case 'cidr':\n    case 'inet':\n    case 'macaddr':\n      return 'string';\n    case 'smallint':\n    case 'integer':\n    case 'int':\n    case 'int2':\n    case 'int4':\n    case 'real':\n    case 'float':\n    case 'float4':\n    case 'float8':\n      return 'number';\n    case 'date':\n    case 'timestamp':\n    case 'timestamptz':\n      return 'Date';\n    case 'json':\n    case 'jsonb':\n      if (x.default) {\n        if (x.default.startsWith(\"'{\")) {\n          return 'Record<string, unknown>';\n        }\n        if (x.default.startsWith(\"'[\")) {\n          return 'unknown[]';\n        }\n      }\n      return 'unknown';\n    case 'bytea':\n      return 'Buffer';\n    case 'interval':\n      return 'PostgresInterval';\n    default:\n      return customTypes.get(udt) ?? 'unknown';\n  }\n}\n\n/**\n * Wraps the target property identifier into quotes in case it contains any\n * invalid characters.\n *\n * @see https://developer.mozilla.org/docs/Glossary/Identifier\n */\nfunction sanitize(name: string): string {\n  return /^[a-zA-Z$_][a-zA-Z$_0-9]*$/.test(name) ? name : JSON.stringify(name);\n}\n\n/**\n * If enabled override a column belonging to a specific table (highest priority),\n * all columns with the same name or overwrite the database's default type (lowest priority).\n * A function can be provided for each override.\n */\nexport function overrideType(x: Column, options: Options): string | null {\n  const typeOverrides = (options.typeOverrides as TypeOverride) ?? {};\n\n  // Override a table's specific column type\n  const overrideTableColumnTypes = options.overrideTableColumnTypes ?? true;\n  if (overrideTableColumnTypes && `${x.table}.${x.column}` in typeOverrides) {\n    const tableColumnType = typeOverrides[`${x.table}.${x.column}`];\n    return isFunction(tableColumnType) ? tableColumnType(x) : tableColumnType;\n  }\n\n  // Override all matching columns type\n  const overrideColumnTypes = options.overrideColumnTypes ?? true;\n  if (overrideColumnTypes && x.column in typeOverrides) {\n    const columnType = typeOverrides[x.column];\n    return isFunction(columnType) ? columnType(x) : columnType;\n  }\n\n  // Override the database's default type if provided.\n  const overrideDefaultTypes = options.overrideDefaultTypes ?? true;\n  const udt = x.type === 'ARRAY' ? x.udt.substring(1) : x.udt;\n  if (overrideDefaultTypes && udt in typeOverrides) {\n    const type = typeOverrides[udt];\n    return isFunction(type) ? type(x) : type;\n  }\n\n  return null;\n}\n\n/**\n * If the \"*\" override has been provided, if it's a function then call it and return\n * the value, otherwise just return the value it holds.\n * If the \"*\" override was not provided just return again the same type.\n * Whatever this function returns will override the processed type.\n */\nexport function typePostProcessor(\n  x: Column,\n  type: string,\n  options: Options\n): string {\n  const typeOverrides = options.typeOverrides ?? {};\n\n  // If the \"*\" has been provided, return its value.\n  if ('*' in typeOverrides) {\n    return isFunction(typeOverrides['*'])\n      ? typeOverrides['*'](x, type)\n      : typeOverrides['*'];\n  }\n\n  // Return the default type\n  return type;\n}\n\n// eslint-disable-next-line @typescript-eslint/ban-types\nfunction isFunction(value: unknown): value is Function {\n  return typeof value === 'function';\n}\n\nexport function overrideName(\n  x: Column,\n  category: NameOverrideCategory,\n  overrides: Record<string, OverrideStringFunction>\n): string | null {\n  let name: string | null = null;\n  const defaultValue = x[category];\n\n  if (category === 'column') {\n    // Run override for specific table column\n    if (`${x.table}.${x.column}` in overrides) {\n      const override = overrides[`${x.table}.${x.column}`];\n      name = isFunction(override)\n        ? override(x, category, defaultValue)\n        : override;\n    } else if (x.column in overrides) {\n      // Run override for all columns with same name\n      const override = overrides[x.column];\n      name = isFunction(override)\n        ? override(x, category, defaultValue)\n        : override;\n    }\n  } else {\n    // Run override for specific name/key\n    if (x[category] in overrides) {\n      const override = overrides[x[category]];\n      name = isFunction(override)\n        ? override(x, category, defaultValue)\n        : override;\n    }\n  }\n\n  if ('*' in overrides) {\n    name = isFunction(overrides['*'])\n      ? overrides['*'](x, category, name)\n      : overrides['*'];\n  }\n\n  return name;\n}\n"],"mappings":"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"}